import { Injectable, Inject } from '@angular/core';
import { L10N_CONFIG, L10N_LOCALE } from '../models/l10n-config';
import { toDate, toNumber, PARSE_DATE_STYLE, PARSE_TIME_STYLE, parseDigits } from '../models/utils';
import * as i0 from "@angular/core";
import * as i1 from "./l10n-translation.service";
class L10nIntlService {
    constructor(config, locale, translation) {
        this.config = config;
        this.locale = locale;
        this.translation = translation;
    }
    /**
     * Formats a date.
     * @param value A date, a number (milliseconds since UTC epoch) or an ISO 8601 string
     * @param options A L10n or Intl DateTimeFormatOptions object
     * @param language The current language
     * @param timeZone The current time zone
     */
    formatDate(value, options, language = this.locale.dateLanguage || this.locale.language, timeZone = this.locale.timeZone) {
        value = toDate(value);
        let dateTimeFormatOptions = {};
        if (options) {
            if (options) {
                const { dateStyle, timeStyle, ...rest } = options;
                if (dateStyle) {
                    dateTimeFormatOptions = { ...dateTimeFormatOptions, ...PARSE_DATE_STYLE[dateStyle] };
                }
                if (timeStyle) {
                    dateTimeFormatOptions = { ...dateTimeFormatOptions, ...PARSE_TIME_STYLE[timeStyle] };
                }
                dateTimeFormatOptions = { ...dateTimeFormatOptions, ...rest };
            }
        }
        if (timeZone) {
            dateTimeFormatOptions.timeZone = timeZone;
        }
        return new Intl.DateTimeFormat(language, dateTimeFormatOptions).format(value);
    }
    /**
     * Formats a number.
     * @param value A number or a string
     * @param options A L10n or Intl NumberFormatOptions object
     * @param language The current language
     * @param currency The current currency
     * @param convert An optional function to convert the value, with value and locale in the signature.
     * For example:
     * ```
     * const convert = (value: number, locale: L10nLocale) => { return ... };
     * ```
     * @param convertParams Optional parameters for the convert function
     */
    formatNumber(value, options, language = this.locale.numberLanguage || this.locale.language, currency = this.locale.currency, convert, convertParams) {
        if (options && options['style'] === 'unit' && !options['unit'])
            return value;
        value = toNumber(value);
        // Optional conversion.
        if (typeof convert === 'function') {
            value = convert(value, this.locale, Object.values(convertParams || {})); // Destructures params
        }
        let numberFormatOptions = {};
        if (options) {
            const { digits, ...rest } = options;
            if (digits) {
                numberFormatOptions = { ...numberFormatOptions, ...parseDigits(digits) };
            }
            numberFormatOptions = { ...numberFormatOptions, ...rest };
        }
        if (currency)
            numberFormatOptions.currency = currency;
        return new Intl.NumberFormat(language, numberFormatOptions).format(value);
    }
    /**
     * Formats a relative time.
     * @param value A negative (or positive) number
     * @param unit An Intl RelativeTimeFormatUnit value
     * @param options An Intl RelativeTimeFormatOptions object
     * @param language The current language
     */
    formatRelativeTime(value, unit, options, language = this.locale.dateLanguage || this.locale.language) {
        value = toNumber(value);
        return new Intl.RelativeTimeFormat(language, options).format(value, unit);
    }
    /**
     * Gets the plural by a number.
     * The 'value' is passed as a parameter to the translation function.
     * @param value The number to get the plural
     * @param prefix Optional prefix for the key
     * @param options An Intl PluralRulesOptions object
     * @param language The current language
     */
    plural(value, prefix = '', options, language = this.locale.language) {
        value = toNumber(value);
        const rule = new Intl.PluralRules(language, options).select(value);
        const key = prefix ? `${prefix}${this.config.keySeparator}${rule}` : rule;
        return this.translation.translate(key, { value });
    }
    /**
     * Returns translation of language, region, script or currency display names
     * @param code ISO code of language, region, script or currency
     * @param options An Intl DisplayNamesOptions object
     * @param language The current language
     */
    displayNames(code, options, language = this.locale.language) {
        return new Intl.DisplayNames(language, options).of(code) || code;
    }
    getCurrencySymbol(locale = this.locale) {
        const decimal = this.formatNumber(0, { digits: '1.0-0' }, locale.numberLanguage || locale.language);
        const currency = this.formatNumber(0, { digits: '1.0-0', style: 'currency', currencyDisplay: 'symbol' }, locale.numberLanguage || locale.language, locale.currency);
        let symbol = currency.replace(decimal, '');
        symbol = symbol.trim();
        return symbol;
    }
    /**
     * Compares two keys by the value of translation.
     * @param key1 First key to compare
     * @param key1 Second key to compare
     * @param options An Intl CollatorOptions object
     * @param language The current language
     * @return A negative value if the value of translation of key1 comes before the value of translation of key2;
     *         a positive value if key1 comes after key2;
     *         0 if they are considered equal or Intl.Collator is not supported
     */
    compare(key1, key2, options, language = this.locale.language) {
        const value1 = this.translation.translate(key1);
        const value2 = this.translation.translate(key2);
        return new Intl.Collator(language, options).compare(value1, value2);
    }
    /**
     * Returns the representation of a list.
     * @param list An array of keys
     * @param options An Intl ListFormatOptions object
     * @param language The current language
     */
    list(list, options, language = this.locale.language) {
        const values = list.map(key => this.translation.translate(key));
        if (language == null || language === '')
            return values.join(', ');
        return new Intl.ListFormat(language, options).format(values);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: L10nIntlService, deps: [{ token: L10N_CONFIG }, { token: L10N_LOCALE }, { token: i1.L10nTranslationService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: L10nIntlService }); }
}
export { L10nIntlService };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.0", ngImport: i0, type: L10nIntlService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [L10N_CONFIG]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [L10N_LOCALE]
                }] }, { type: i1.L10nTranslationService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibDEwbi1pbnRsLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyLWwxMG4vc3JjL2xpYi9zZXJ2aWNlcy9sMTBuLWludGwuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUduRCxPQUFPLEVBQWMsV0FBVyxFQUFFLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzdFLE9BQU8sRUFDSCxNQUFNLEVBQ04sUUFBUSxFQUNSLGdCQUFnQixFQUNoQixnQkFBZ0IsRUFDaEIsV0FBVyxFQUNkLE1BQU0saUJBQWlCLENBQUM7OztBQUd6QixNQUEyQixlQUFlO0lBRXRDLFlBQ2lDLE1BQWtCLEVBQ2xCLE1BQWtCLEVBQ3ZDLFdBQW1DO1FBRmQsV0FBTSxHQUFOLE1BQU0sQ0FBWTtRQUNsQixXQUFNLEdBQU4sTUFBTSxDQUFZO1FBQ3ZDLGdCQUFXLEdBQVgsV0FBVyxDQUF3QjtJQUMzQyxDQUFDO0lBRUw7Ozs7OztPQU1HO0lBQ0ksVUFBVSxDQUNiLEtBQVUsRUFDVixPQUFtQyxFQUNuQyxRQUFRLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQzNELFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVE7UUFFL0IsS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUV0QixJQUFJLHFCQUFxQixHQUErQixFQUFFLENBQUM7UUFDM0QsSUFBSSxPQUFPLEVBQUU7WUFDVCxJQUFJLE9BQU8sRUFBRTtnQkFDVCxNQUFNLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxHQUFHLElBQUksRUFBRSxHQUFHLE9BQU8sQ0FBQztnQkFDbEQsSUFBSSxTQUFTLEVBQUU7b0JBQ1gscUJBQXFCLEdBQUcsRUFBRSxH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c291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQgeyBMMTBuTG9jYWxlLCBMMTBuRGF0ZVRpbWVGb3JtYXRPcHRpb25zLCBMMTBuTnVtYmVyRm9ybWF0T3B0aW9ucyB9IGZyb20gJy4uL21vZGVscy90eXBlcyc7XHJcbmltcG9ydCB7IEwxMG5Db25maWcsIEwxME5fQ09ORklHLCBMMTBOX0xPQ0FMRSB9IGZyb20gJy4uL21vZGVscy9sMTBuLWNvbmZpZyc7XHJcbmltcG9ydCB7XHJcbiAgICB0b0RhdGUsXHJcbiAgICB0b051bWJlcixcclxuICAgIFBBUlNFX0RBVEVfU1RZTEUsXHJcbiAgICBQQVJTRV9USU1FX1NUWUxFLFxyXG4gICAgcGFyc2VEaWdpdHNcclxufSBmcm9tICcuLi9tb2RlbHMvdXRpbHMnO1xyXG5pbXBvcnQgeyBMMTBuVHJhbnNsYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9sMTBuLXRyYW5zbGF0aW9uLnNlcnZpY2UnO1xyXG5cclxuQEluamVjdGFibGUoKSBleHBvcnQgY2xhc3MgTDEwbkludGxTZXJ2aWNlIHtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBASW5qZWN0KEwxME5fQ09ORklHKSBwcml2YXRlIGNvbmZpZzogTDEwbkNvbmZpZyxcclxuICAgICAgICBASW5qZWN0KEwxME5fTE9DQUxFKSBwcml2YXRlIGxvY2FsZTogTDEwbkxvY2FsZSxcclxuICAgICAgICBwcml2YXRlIHRyYW5zbGF0aW9uOiBMMTBuVHJhbnNsYXRpb25TZXJ2aWNlXHJcbiAgICApIHsgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRm9ybWF0cyBhIGRhdGUuXHJcbiAgICAgKiBAcGFyYW0gdmFsdWUgQSBkYXRlLCBhIG51bWJlciAobWlsbGlzZWNvbmRzIHNpbmNlIFVUQyBlcG9jaCkgb3IgYW4gSVNPIDg2MDEgc3RyaW5nXHJcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBBIEwxMG4gb3IgSW50bCBEYXRlVGltZUZvcm1hdE9wdGlvbnMgb2JqZWN0XHJcbiAgICAgKiBAcGFyYW0gbGFuZ3VhZ2UgVGhlIGN1cnJlbnQgbGFuZ3VhZ2VcclxuICAgICAqIEBwYXJhbSB0aW1lWm9uZSBUaGUgY3VycmVudCB0aW1lIHpvbmVcclxuICAgICAqL1xyXG4gICAgcHVibGljIGZvcm1hdERhdGUoXHJcbiAgICAgICAgdmFsdWU6IGFueSxcclxuICAgICAgICBvcHRpb25zPzogTDEwbkRhdGVUaW1lRm9ybWF0T3B0aW9ucyxcclxuICAgICAgICBsYW5ndWFnZSA9IHRoaXMubG9jYWxlLmRhdGVMYW5ndWFnZSB8fCB0aGlzLmxvY2FsZS5sYW5ndWFnZSxcclxuICAgICAgICB0aW1lWm9uZSA9IHRoaXMubG9jYWxlLnRpbWVab25lXHJcbiAgICApOiBzdHJpbmcge1xyXG4gICAgICAgIHZhbHVlID0gdG9EYXRlKHZhbHVlKTtcclxuXHJcbiAgICAgICAgbGV0IGRhdGVUaW1lRm9ybWF0T3B0aW9uczogSW50bC5EYXRlVGltZUZvcm1hdE9wdGlvbnMgPSB7fTtcclxuICAgICAgICBpZiAob3B0aW9ucykge1xyXG4gICAgICAgICAgICBpZiAob3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgeyBkYXRlU3R5bGUsIHRpbWVTdHlsZSwgLi4ucmVzdCB9ID0gb3B0aW9ucztcclxuICAgICAgICAgICAgICAgIGlmIChkYXRlU3R5bGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRlVGltZUZvcm1hdE9wdGlvbnMgPSB7IC4uLmRhdGVUaW1lRm9ybWF0T3B0aW9ucywgLi4uUEFSU0VfREFURV9TVFlMRVtkYXRlU3R5bGVdIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAodGltZVN0eWxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0ZVRpbWVGb3JtYXRPcHRpb25zID0geyAuLi5kYXRlVGltZUZvcm1hdE9wdGlvbnMsIC4uLlBBUlNFX1RJTUVfU1RZTEVbdGltZVN0eWxlXSB9O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZGF0ZVRpbWVGb3JtYXRPcHRpb25zID0geyAuLi5kYXRlVGltZUZvcm1hdE9wdGlvbnMsIC4uLnJlc3QgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGltZVpvbmUpIHtcclxuICAgICAgICAgICAgZGF0ZVRpbWVGb3JtYXRPcHRpb25zLnRpbWVab25lID0gdGltZVpvbmU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbmV3IEludGwuRGF0ZVRpbWVGb3JtYXQobGFuZ3VhZ2UsIGRhdGVUaW1lRm9ybWF0T3B0aW9ucykuZm9ybWF0KHZhbHVlKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEZvcm1hdHMgYSBudW1iZXIuXHJcbiAgICAgKiBAcGFyYW0gdmFsdWUgQSBudW1iZXIgb3IgYSBzdHJpbmdcclxuICAgICAqIEBwYXJhbSBvcHRpb25zIEEgTDEwbiBvciBJbnRsIE51bWJlckZvcm1hdE9wdGlvbnMgb2JqZWN0XHJcbiAgICAgKiBAcGFyYW0gbGFuZ3VhZ2UgVGhlIGN1cnJlbnQgbGFuZ3VhZ2VcclxuICAgICAqIEBwYXJhbSBjdXJyZW5jeSBUaGUgY3VycmVudCBjdXJyZW5jeVxyXG4gICAgICogQHBhcmFtIGNvbnZlcnQgQW4gb3B0aW9uYWwgZnVuY3Rpb24gdG8gY29udmVydCB0aGUgdmFsdWUsIHdpdGggdmFsdWUgYW5kIGxvY2FsZSBpbiB0aGUgc2lnbmF0dXJlLiBcclxuICAgICAqIEZvciBleGFtcGxlOlxyXG4gICAgICogYGBgXHJcbiAgICAgKiBjb25zdCBjb252ZXJ0ID0gKHZhbHVlOiBudW1iZXIsIGxvY2FsZTogTDEwbkxvY2FsZSkgPT4geyByZXR1cm4gLi4uIH07XHJcbiAgICAgKiBgYGBcclxuICAgICAqIEBwYXJhbSBjb252ZXJ0UGFyYW1zIE9wdGlvbmFsIHBhcmFtZXRlcnMgZm9yIHRoZSBjb252ZXJ0IGZ1bmN0aW9uXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBmb3JtYXROdW1iZXIoXHJcbiAgICAgICAgdmFsdWU6IGFueSxcclxuICAgICAgICBvcHRpb25zPzogTDEwbk51bWJlckZvcm1hdE9wdGlvbnMsXHJcbiAgICAgICAgbGFuZ3VhZ2UgPSB0aGlzLmxvY2FsZS5udW1iZXJMYW5ndWFnZSB8fCB0aGlzLmxvY2FsZS5sYW5ndWFnZSxcclxuICAgICAgICBjdXJyZW5jeSA9IHRoaXMubG9jYWxlLmN1cnJlbmN5LFxyXG4gICAgICAgIGNvbnZlcnQ/OiAodmFsdWU6IG51bWJlciwgbG9jYWxlOiBMMTBuTG9jYWxlLCBwYXJhbXM6IGFueSkgPT4gbnVtYmVyLFxyXG4gICAgICAgIGNvbnZlcnRQYXJhbXM/OiBhbnlcclxuICAgICk6IHN0cmluZyB7XHJcbiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9uc1snc3R5bGUnXSA9PT0gJ3VuaXQnICYmICFvcHRpb25zWyd1bml0J10pIHJldHVybiB2YWx1ZTtcclxuXHJcbiAgICAgICAgdmFsdWUgPSB0b051bWJlcih2YWx1ZSk7XHJcblxyXG4gICAgICAgIC8vIE9wdGlvbmFsIGNvbnZlcnNpb24uXHJcbiAgICAgICAgaWYgKHR5cGVvZiBjb252ZXJ0ID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgIHZhbHVlID0gY29udmVydCh2YWx1ZSwgdGhpcy5sb2NhbGUsIE9iamVjdC52YWx1ZXMoY29udmVydFBhcmFtcyB8fCB7fSkpOyAvLyBEZXN0cnVjdHVyZXMgcGFyYW1zXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgbnVtYmVyRm9ybWF0T3B0aW9uczogSW50bC5OdW1iZXJGb3JtYXRPcHRpb25zID0ge307XHJcbiAgICAgICAgaWYgKG9wdGlvbnMpIHtcclxuICAgICAgICAgICAgY29uc3QgeyBkaWdpdHMsIC4uLnJlc3QgfSA9IG9wdGlvbnM7XHJcbiAgICAgICAgICAgIGlmIChkaWdpdHMpIHtcclxuICAgICAgICAgICAgICAgIG51bWJlckZvcm1hdE9wdGlvbnMgPSB7IC4uLm51bWJlckZvcm1hdE9wdGlvbnMsIC4uLnBhcnNlRGlnaXRzKGRpZ2l0cykgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBudW1iZXJGb3JtYXRPcHRpb25zID0geyAuLi5udW1iZXJGb3JtYXRPcHRpb25zLCAuLi5yZXN0IH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjdXJyZW5jeSkgbnVtYmVyRm9ybWF0T3B0aW9ucy5jdXJyZW5jeSA9IGN1cnJlbmN5O1xyXG5cclxuICAgICAgICByZXR1cm4gbmV3IEludGwuTnVtYmVyRm9ybWF0KGxhbmd1YWdlLCBudW1iZXJGb3JtYXRPcHRpb25zKS5mb3JtYXQodmFsdWUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRm9ybWF0cyBhIHJlbGF0aXZlIHRpbWUuXHJcbiAgICAgKiBAcGFyYW0gdmFsdWUgQSBuZWdhdGl2ZSAob3IgcG9zaXRpdmUpIG51bWJlclxyXG4gICAgICogQHBhcmFtIHVuaXQgQW4gSW50bCBSZWxhdGl2ZVRpbWVGb3JtYXRVbml0IHZhbHVlXHJcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBBbiBJbnRsIFJlbGF0aXZlVGltZUZvcm1hdE9wdGlvbnMgb2JqZWN0XHJcbiAgICAgKiBAcGFyYW0gbGFuZ3VhZ2UgVGhlIGN1cnJlbnQgbGFuZ3VhZ2VcclxuICAgICAqL1xyXG4gICAgcHVibGljIGZvcm1hdFJlbGF0aXZlVGltZShcclxuICAgICAgICB2YWx1ZTogYW55LFxyXG4gICAgICAgIHVuaXQ6IEludGwuUmVsYXRpdmVUaW1lRm9ybWF0VW5pdCxcclxuICAgICAgICBvcHRpb25zPzogSW50bC5SZWxhdGl2ZVRpbWVGb3JtYXRPcHRpb25zLFxyXG4gICAgICAgIGxhbmd1YWdlID0gdGhpcy5sb2NhbGUuZGF0ZUxhbmd1YWdlIHx8IHRoaXMubG9jYWxlLmxhbmd1YWdlXHJcbiAgICApOiBzdHJpbmcge1xyXG4gICAgICAgIHZhbHVlID0gdG9OdW1iZXIodmFsdWUpO1xyXG5cclxuICAgICAgICByZXR1cm4gbmV3IEludGwuUmVsYXRpdmVUaW1lRm9ybWF0KGxhbmd1YWdlLCBvcHRpb25zKS5mb3JtYXQodmFsdWUsIHVuaXQpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0cyB0aGUgcGx1cmFsIGJ5IGEgbnVtYmVyLlxyXG4gICAgICogVGhlICd2YWx1ZScgaXMgcGFzc2VkIGFzIGEgcGFyYW1ldGVyIHRvIHRoZSB0cmFuc2xhdGlvbiBmdW5jdGlvbi5cclxuICAgICAqIEBwYXJhbSB2YWx1ZSBUaGUgbnVtYmVyIHRvIGdldCB0aGUgcGx1cmFsXHJcbiAgICAgKiBAcGFyYW0gcHJlZml4IE9wdGlvbmFsIHByZWZpeCBmb3IgdGhlIGtleVxyXG4gICAgICogQHBhcmFtIG9wdGlvbnMgQW4gSW50bCBQbHVyYWxSdWxlc09wdGlvbnMgb2JqZWN0XHJcbiAgICAgKiBAcGFyYW0gbGFuZ3VhZ2UgVGhlIGN1cnJlbnQgbGFuZ3VhZ2VcclxuICAgICAqL1xyXG4gICAgcHVibGljIHBsdXJhbCh2YWx1ZTogYW55LCBwcmVmaXggPSAnJywgb3B0aW9ucz86IEludGwuUGx1cmFsUnVsZXNPcHRpb25zLCBsYW5ndWFnZSA9IHRoaXMubG9jYWxlLmxhbmd1YWdlKTogc3RyaW5nIHtcclxuICAgICAgICB2YWx1ZSA9IHRvTnVtYmVyKHZhbHVlKTtcclxuXHJcbiAgICAgICAgY29uc3QgcnVsZSA9IG5ldyBJbnRsLlBsdXJhbFJ1bGVzKGxhbmd1YWdlLCBvcHRpb25zKS5zZWxlY3QodmFsdWUpO1xyXG5cclxuICAgICAgICBjb25zdCBrZXkgPSBwcmVmaXggPyBgJHtwcmVmaXh9JHt0aGlzLmNvbmZpZy5rZXlTZXBhcmF0b3J9JHtydWxlfWAgOiBydWxlO1xyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy50cmFuc2xhdGlvbi50cmFuc2xhdGUoa2V5LCB7IHZhbHVlIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmV0dXJucyB0cmFuc2xhdGlvbiBvZiBsYW5ndWFnZSwgcmVnaW9uLCBzY3JpcHQgb3IgY3VycmVuY3kgZGlzcGxheSBuYW1lc1xyXG4gICAgICogQHBhcmFtIGNvZGUgSVNPIGNvZGUgb2YgbGFuZ3VhZ2UsIHJlZ2lvbiwgc2NyaXB0IG9yIGN1cnJlbmN5XHJcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBBbiBJbnRsIERpc3BsYXlOYW1lc09wdGlvbnMgb2JqZWN0XHJcbiAgICAgKiBAcGFyYW0gbGFuZ3VhZ2UgVGhlIGN1cnJlbnQgbGFuZ3VhZ2VcclxuICAgICAqL1xyXG4gICAgcHVibGljIGRpc3BsYXlOYW1lcyhjb2RlOiBzdHJpbmcsIG9wdGlvbnM6IEludGwuRGlzcGxheU5hbWVzT3B0aW9ucywgbGFuZ3VhZ2UgPSB0aGlzLmxvY2FsZS5sYW5ndWFnZSk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBJbnRsLkRpc3BsYXlOYW1lcyhsYW5ndWFnZSwgb3B0aW9ucykub2YoY29kZSkgfHwgY29kZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0Q3VycmVuY3lTeW1ib2wobG9jYWxlID0gdGhpcy5sb2NhbGUpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIGNvbnN0IGRlY2ltYWwgPSB0aGlzLmZvcm1hdE51bWJlcigwLCB7IGRpZ2l0czogJzEuMC0wJyB9LCBsb2NhbGUubnVtYmVyTGFuZ3VhZ2UgfHwgbG9jYWxlLmxhbmd1YWdlKTtcclxuICAgICAgICBjb25zdCBjdXJyZW5jeSA9IHRoaXMuZm9ybWF0TnVtYmVyKFxyXG4gICAgICAgICAgICAwLFxyXG4gICAgICAgICAgICB7IGRpZ2l0czogJzEuMC0wJywgc3R5bGU6ICdjdXJyZW5jeScsIGN1cnJlbmN5RGlzcGxheTogJ3N5bWJvbCcgfSxcclxuICAgICAgICAgICAgbG9jYWxlLm51bWJlckxhbmd1YWdlIHx8IGxvY2FsZS5sYW5ndWFnZSxcclxuICAgICAgICAgICAgbG9jYWxlLmN1cnJlbmN5XHJcbiAgICAgICAgKTtcclxuICAgICAgICBsZXQgc3ltYm9sID0gY3VycmVuY3kucmVwbGFjZShkZWNpbWFsLCAnJyk7XHJcbiAgICAgICAgc3ltYm9sID0gc3ltYm9sLnRyaW0oKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHN5bWJvbDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENvbXBhcmVzIHR3byBrZXlzIGJ5IHRoZSB2YWx1ZSBvZiB0cmFuc2xhdGlvbi5cclxuICAgICAqIEBwYXJhbSBrZXkxIEZpcnN0IGtleSB0byBjb21wYXJlXHJcbiAgICAgKiBAcGFyYW0ga2V5MSBTZWNvbmQga2V5IHRvIGNvbXBhcmVcclxuICAgICAqIEBwYXJhbSBvcHRpb25zIEFuIEludGwgQ29sbGF0b3JPcHRpb25zIG9iamVjdFxyXG4gICAgICogQHBhcmFtIGxhbmd1YWdlIFRoZSBjdXJyZW50IGxhbmd1YWdlXHJcbiAgICAgKiBAcmV0dXJuIEEgbmVnYXRpdmUgdmFsdWUgaWYgdGhlIHZhbHVlIG9mIHRyYW5zbGF0aW9uIG9mIGtleTEgY29tZXMgYmVmb3JlIHRoZSB2YWx1ZSBvZiB0cmFuc2xhdGlvbiBvZiBrZXkyO1xyXG4gICAgICogICAgICAgICBhIHBvc2l0aXZlIHZhbHVlIGlmIGtleTEgY29tZXMgYWZ0ZXIga2V5MjtcclxuICAgICAqICAgICAgICAgMCBpZiB0aGV5IGFyZSBjb25zaWRlcmVkIGVxdWFsIG9yIEludGwuQ29sbGF0b3IgaXMgbm90IHN1cHBvcnRlZFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgY29tcGFyZShrZXkxOiBzdHJpbmcsIGtleTI6IHN0cmluZywgb3B0aW9ucz86IEludGwuQ29sbGF0b3JPcHRpb25zLCBsYW5ndWFnZSA9IHRoaXMubG9jYWxlLmxhbmd1YWdlKTogbnVtYmVyIHtcclxuICAgICAgICBjb25zdCB2YWx1ZTEgPSB0aGlzLnRyYW5zbGF0aW9uLnRyYW5zbGF0ZShrZXkxKTtcclxuICAgICAgICBjb25zdCB2YWx1ZTIgPSB0aGlzLnRyYW5zbGF0aW9uLnRyYW5zbGF0ZShrZXkyKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIG5ldyBJbnRsLkNvbGxhdG9yKGxhbmd1YWdlLCBvcHRpb25zKS5jb21wYXJlKHZhbHVlMSwgdmFsdWUyKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJldHVybnMgdGhlIHJlcHJlc2VudGF0aW9uIG9mIGEgbGlzdC5cclxuICAgICAqIEBwYXJhbSBsaXN0IEFuIGFycmF5IG9mIGtleXNcclxuICAgICAqIEBwYXJhbSBvcHRpb25zIEFuIEludGwgTGlzdEZvcm1hdE9wdGlvbnMgb2JqZWN0XHJcbiAgICAgKiBAcGFyYW0gbGFuZ3VhZ2UgVGhlIGN1cnJlbnQgbGFuZ3VhZ2VcclxuICAgICAqL1xyXG4gICAgcHVibGljIGxpc3QobGlzdDogc3RyaW5nW10sIG9wdGlvbnM/OiBJbnRsLkxpc3RGb3JtYXRPcHRpb25zLCBsYW5ndWFnZSA9IHRoaXMubG9jYWxlLmxhbmd1YWdlKTogc3RyaW5nIHtcclxuICAgICAgICBjb25zdCB2YWx1ZXMgPSBsaXN0Lm1hcChrZXkgPT4gdGhpcy50cmFuc2xhdGlvbi50cmFuc2xhdGUoa2V5KSk7XHJcbiAgICAgICAgaWYgKGxhbmd1YWdlID09IG51bGwgfHwgbGFuZ3VhZ2UgPT09ICcnKSByZXR1cm4gdmFsdWVzLmpvaW4oJywgJyk7XHJcblxyXG4gICAgICAgIHJldHVybiBuZXcgSW50bC5MaXN0Rm9ybWF0KGxhbmd1YWdlLCBvcHRpb25zKS5mb3JtYXQodmFsdWVzKTtcclxuICAgIH1cclxuXHJcbn1cclxuIl19